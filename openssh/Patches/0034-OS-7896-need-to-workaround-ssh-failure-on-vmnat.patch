From 68081bdb4a0983370c6c82fd3a2ed8016b14b5d8 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Tue, 23 Jul 2019 11:54:10 +0000
Subject: [PATCH 34/34] OS-7896 need to workaround ssh failure on vmnat

---
 ssh_config  | 5 +++++
 sshd_config | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/ssh_config b/ssh_config
index bcb9f153..b2b67fc5 100644
--- a/ssh_config
+++ b/ssh_config
@@ -46,3 +46,8 @@
 #   VisualHostKey no
 #   ProxyCommand ssh -q -W %h:%p gateway.example.com
 #   RekeyLimit 1G 1h
+
+# VMware's vmnat injects a RST when it sees AF21/CS1 DSCP flags.  This breaks
+# ssh on CoaL and other SmartOS-on-VMware scenarios.
+Host *
+    IPQoS none
diff --git a/sshd_config b/sshd_config
index 6184ab75..49974768 100644
--- a/sshd_config
+++ b/sshd_config
@@ -116,6 +116,10 @@ PrintLastLog no
 # override default of no subsystems
 Subsystem	sftp	/usr/libexec/sftp-server
 
+# VMware's vmnat injects a RST when it sees AF21/CS1 DSCP flags.  This breaks
+# ssh on CoaL and other SmartOS-on-VMware scenarios.
+IPQoS none
+
 # Example of overriding settings on a per-user basis
 #Match User anoncvs
 #	X11Forwarding no
-- 
2.22.0

