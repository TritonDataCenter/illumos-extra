From d4c95f6d7ddff763faf4dcafcac0d083d9e5b801 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Fri, 16 Nov 2018 10:13:59 +0000
Subject: [PATCH] libgcc-unwind.map should be version 2 for SunOS ld, to
 prevent -z guidance from complaining.

---
diff --git a/libgcc/config/t-slibgcc-sld b/libgcc/config/t-slibgcc-sld
index 0b95391..55fd6e1 100644
--- a/libgcc/config/t-slibgcc-sld
+++ b/libgcc/config/t-slibgcc-sld
@@ -8,13 +8,32 @@ ifeq ($(enable_shared),yes)
 
 # Linker mapfile to enforce direct binding to libgcc_s unwinder
 # (PR target/59788).
+
+ifeq ($(with_gnu_ld),yes)
+
+libgcc-unwind.map: libgcc-std.ver
+	@(echo "{";                             \
+	for f in `grep _Unwind_ $< | sort`; do  \
+	  echo "        $$f = EXTERN DIRECT;";  \
+	done;                                   \
+	echo "};" ) > $@
+
+else
+
 libgcc-unwind.map: libgcc-std.ver
-	@(echo "{";				\
-	for f in `grep _Unwind_ $< | sort`; do	\
-	  echo "	$$f = EXTERN DIRECT;";	\
-	done;					\
+	@(echo "# Generated by libgcc/config/t-slibgcc-sld";	\
+	echo;							\
+	echo '$$mapfile_version 2'; 				\
+	echo;							\
+	echo "SYMBOL_SCOPE {";					\
+	echo "    global:";					\
+	for f in `grep _Unwind_ $< | sort`; do			\
+	  echo "	$$f { FLAGS = EXTERN DIRECT };";	\
+	done;							\
 	echo "};" ) > $@
 
+endif
+
 # Copy libgcc-unwind.map to the place where gcc will look for it at build-time.
 install-libgcc-unwind-map-forbuild: libgcc-unwind.map
 	dest=$(gcc_objdir)/tmp$$$$-$<; \
-- 
2.14.1

